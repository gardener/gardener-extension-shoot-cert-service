{{- if .Values.gep19Monitoring }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: shoot-cert-controller-manager
  namespace: {{ .Release.Namespace }}
  labels:
    prometheus: shoot
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "cert-management.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  endpoints:
  - port: metrics
    relabelings:
    - action: labelmap
      regex: __meta_kubernetes_service_label_(.+)
    metricRelabelings:
    - sourceLabels:
      - __name__
      action: keep
      regex: ^(cert_management_.+)$
    - sourceLabels: [ __name__, code ]
      regex: ^(promhttp_metric_handler_requests_total);(200|500|503|400|404)$
      target_label: __name__
      replacement: cert_controller_manager_$1
  honorLabels: false
{{- end }}
